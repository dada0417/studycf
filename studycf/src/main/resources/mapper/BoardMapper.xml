<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="studycf.mapper.BoardMapper">
	<resultMap type="Board" 						id="boardResultMap">
		<id 	column="board_cd"					property="boardCd"/>
		<result column="board_ctg_cd"				property="boardCtgCd"/>
		<result column="user_id"					property="userId"/>
		<result column="board_title"				property="boardTitle"/>
		<result column="board_content"				property="boardContent"/>
		<result column="board_date"					property="boardDate"/>
		<result column="board_views"				property="boardViews"/>
		<association property="boardCtg" 	javaType="BoardCtg">
			<id 	 column="board_ctg_cd" 	property="boardCtgCd"/>
			<result  column="board_ctg_nm" 	property="boardCtgNm"/>
		</association>
		<collection property="tFile" ofType="TFile">
			<id		column="file_cd"				property="fileCd"/>
			<result	column="original_file_nm"		property="originalFileName"/>
			<result	column="stored_file_path"		property="storedFilePath"/>
			<result	column="file_size"				property="fileSize"/>
			<result column="re_file_name"			property="reFileName"/>
			<result	column="uploader_id"			property="uploaderId"/>
			<result	column="upload_date"			property="uploadDate"/>
			<result	column="updator_id"				property="updatorId"/>
			<result	column="updated_date"			property="updatedDate"/>
			<result	column="represent_img"			property="representImg"/>
		</collection>
		<collection property="relFileWithBoard" ofType="Map">
			<result	column="board_cd"	property="boardCd"/>
			<result	column="file_cd"			property="fileCd"/>
		</collection>
	</resultMap>
	<resultMap type="BoardComment" 					id="boardCommentResultMap">
		<id		column="board_comment_cd"			property="boardCommentCd"/>
		<result column="board_cd"					property="boardCd"/>
		<result column="user_id"					property="userId"/>
		<result column="board_comment_detail"		property="boardCommentDetail"/>
		<result column="board_comment_date"			property="boardCommentDate"/>
		<result column="board_comment_state"		property="boardCommentState"/>
		<result column="parent_cd"					property="parentCd"/>
		<result column="pa_order"					property="paOrder"/>
	</resultMap>
	


	<!-- 게시글 댓글 수 -->
	<select id="commentCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			board_comment
		Where
			board_cd = #{boardCd};
	</select>

	<!-- 게시글 댓글 리스트 조회 -->
	<select id="getBoardCommentList" parameterType="String" resultMap="boardCommentResultMap">
		SELECT 
			c.board_comment_cd
			, c.board_cd
			, c.user_id
			, c.board_comment_detail
			, c.board_comment_date
			, c.board_comment_state
			, c.parent_cd
			, c.pa_order
		FROM 
			board_comment AS c
		<trim prefix="WHERE" prefixOverrides="and">
			<if test="boardCd != null and boardCd != ''">
				c.board_cd = #{boardCd}
			</if>
			<if test="parentCd != null and parentCd != ''">
				c.parent_cd = #{parentCd}
			</if>
			<if test="boardCommentCd != null and boardCommentCd != ''">
				c.board_comment_cd = #{boardCommentCd}
			</if>
		</trim>
		order by c.parent_cd, c.pa_order;
	</select>
	
	
	<!-- 게시글 댓글 등록 -->
	<insert id="addBoardComment" parameterType="boardComment">
		INSERT INTO board_comment
		(		 board_comment_cd
				,board_cd
				,user_id
				,board_comment_detail
				,board_comment_state
				,board_comment_date
				,parent_cd
				,pa_order
		)VALUES	(
					(SELECT
						CONCAT('board_comment_', LPAD(MAX(CAST(SUBSTRING_INDEX(p.board_comment_cd,'_',-1) AS UNSIGNED))+1,2,0))
					FROM
						board_comment AS p)	
						
				,#{boardCd}
				,#{userId}
				,#{boardCommentDetail}
				,'N'
				,NOW()
				,#{parentCd}
				,#{paOrder}
		);
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="modifyBoard" parameterType="Board">
		UPDATE 
			board
		SET
			board_ctg_cd = #{boardCtgCd},
			board_title = #{boardTitle},
			board_content = #{boardContent}
		WHERE
			board_cd = #{boardCd};
	</update>
	
	<!-- 다음글 보기 -->
	<select id="getBoardNext" parameterType="String" resultMap="boardResultMap">
		<![CDATA[
		SELECT
		    board_cd,
		    board_title
		 FROM
		    board
		 WHERE
		  board_cd =
		    (SELECT board_cd FROM board WHERE board_cd > #{boardCd}  ORDER BY board_cd LIMIT 1);
		]]>
	</select>
	
	<!-- 이전글 보기 -->
	<select id="getBoardPre" parameterType="String" resultMap="boardResultMap">
		<![CDATA[
		SELECT
		    board_cd,
		    board_title
		 FROM
		    board
		 WHERE
		  board_cd =
		    (SELECT board_cd FROM board WHERE board_cd < #{boardCd}  ORDER BY board_cd DESC LIMIT 1);
		]]>
	</select>
		
	
	<!-- 게시글 상세보기 -->
	<select id="getBoardDetail" parameterType="String" resultMap="boardResultMap">
		SELECT
				b.board_cd
				,b.board_ctg_cd
				,b.user_id
				,b.board_title
				,b.board_content
				,b.board_date
				,b.board_views
				,bc.board_ctg_nm
				,rb.file_cd
				,t.original_file_nm
				,t.stored_file_path
				,t.file_size
				,t.represent_img
				,t.deleted_yn
				,t.re_file_name
		FROM
			board AS b
			INNER join
			board_ctg AS bc
			on
			b.board_ctg_cd = bc.board_ctg_cd
			left JOIN
			rel_file_with_board AS rb
			on
			b.board_cd = rb.board_cd
			left JOIN 
			t_file AS t
			on
			t.file_cd = rb.file_cd	
		<trim prefix="WHERE">
			<if test="boardCd != null and boardCd != ''">
				b.board_cd = #{boardCd}
			</if>
		</trim>
	</select>
	
	<!-- 게시글 조회수 -->
	<update id="boardViewUpdate" parameterType="String">
		UPDATE 
			board
		SET
			board_views = board_views+1
		<trim prefix="WHERE">
			<if test="boardCd != null and boardCd != ''">
				board_cd = #{boardCd}
			</if>
		</trim>
	</update>
	
	<!-- 게시글 목록 -->
	<select id="getBoardList" parameterType="map" resultType="map" resultMap="boardResultMap">
		SELECT
			b.board_cd					
			,b.board_ctg_cd		
			,bc.board_ctg_nm
			,b.user_id						
			,b.board_title				
			,b.board_content			
			,b.board_date				
			,b.board_views				
		FROM
			board AS b
			inner join
			board_ctg as bc
			on
			b.board_ctg_cd = bc.board_ctg_cd
		ORDER BY board_cd DESC
		LIMIT #{startRow}, #{rowPerPage};
	</select>
	
	<!-- 게시글 총 튜플 수 -->
	<select id="getBoardCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			board;
	</select>
	
	
	<!-- 게시글 작성 -->
	<insert id="addBoard" parameterType="Board">
		<selectKey resultType="String" keyProperty="boardCd" order="BEFORE">
			SELECT sf_new_board_cd()
		</selectKey>
		INSERT INTO board
			(board_cd
			, board_ctg_cd
			, user_id
			, board_title
			, board_content
			, board_date
			, board_views)
		VALUES(
			sf_new_board_cd()
			, #{boardCtgCd}
			, #{userId}
			, #{boardTitle}
			, #{boardContent}
			, NOW()
			, #{boardViews}
			, 0);
	</insert>
	
	
	<!-- 게시글 카테고리 조회 -->
	<select id="getBoardCtg" parameterType="String" resultMap="boardResultMap">
		SELECT 
			bc.board_ctg_cd
			, bc.board_ctg_nm
		FROM 
			board_ctg AS bc;
	</select>
	
	


	

	
	

	
</mapper>